/*
 * Name: SewisePlayer danmu plugin
 * Author: keyun
 * Website: http://player.sewise.com
 * Date: October 26, 2015
 * Copyright: 2013-2016, Sewise
 * Mail: keyun@sewise.com
 * jquery.danmu.js (//github.com/chiruom/danmu/) - Licensed under the MIT license
 * 
 */

!function(a){a.jQueryPlugin=function(b){a.fn[b]=function(c){var d=Array.prototype.slice.call(arguments,1);return this.length?this.each(function(){var e=a.data(this,b)||a.data(this,b,new cyntax.plugins[b](this,c)._init());"string"==typeof c&&(c=c.replace(/^_/,""),e[c]&&e[c].apply(e,d))}):void 0}}}(jQuery);var cyntax={plugins:{}};!function(){function a(){return(new Date).getTime()}var b=jQuery,c="jQuery.pause",d=1,e=b.fn.animate,f={};b.fn.animate=function(g,h,i,j){var k=b.speed(h,i,j);return k.complete=k.old,this.each(function(){this[c]||(this[c]=d++);var h=b.extend({},k);e.apply(b(this),[g,b.extend({},h)]),f[this[c]]={run:!0,prop:g,opt:h,start:a(),done:0}})},b.fn.pause=function(){return this.each(function(){this[c]||(this[c]=d++);var e=f[this[c]];e&&e.run&&(e.done+=a()-e.start,e.done>e.opt.duration?delete f[this[c]]:(b(this).stop().stop().stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),b(this).stop(),e.run=!1))})},b.fn.resume=function(){return this.each(function(){this[c]||(this[c]=d++);var g=f[this[c]];g&&!g.run&&(g.opt.duration-=g.done,g.done=0,g.run=!0,g.start=a(),e.apply(b(this),[g.prop,b.extend({},g.opt)]))})}}(),function(a){cyntax.plugins.timer=function(b,c){this.$this=a(b),this.options=a.extend({},this.defaults,c),this.timer_info={id:null,index:null,state:0}},cyntax.plugins.timer.prototype={defaults:{delay:1e3,repeat:!1,autostart:!0,callback:null,url:"",post:""},_init:function(){return this.options.autostart&&(this.timer_info.state=1,this.timer_info.id=setTimeout(a.proxy(this._timer_fn,this),this.options.delay)),this},_timer_fn:function(){"function"==typeof this.options.callback?a.proxy(this.options.callback,this.$this).call(this,++this.timer_info.index):"string"==typeof this.options.url&&(ajax_options={url:this.options.url,context:this,type:"string"==typeof this.options.post&&""!=typeof this.options.post==""?"POST":"GET",success:function(a){this.$this.html(a)}},"string"==typeof this.options.post&&""!=typeof this.options.post&&(ajax_options.data=this.options.post),a.ajax(ajax_options)),this.options.repeat&&1==this.timer_info.state&&("boolean"==typeof this.options.repeat||parseInt(this.options.repeat)>this.timer_info.index)?this.timer_info.id=setTimeout(a.proxy(this._timer_fn,this),this.options.delay):this.timer_id=null},start:function(){0==this.timer_info.state&&(this.timer_info.index=0,this.timer_info.state=1,this.timer_id=setTimeout(a.proxy(this._timer_fn,this),this.options.delay))},stop:function(){1==this.timer_info.state&&this.timer_info.id&&(clearTimeout(this.timer_info.id),this.timer_id=null),this.timer_info.state=0},pause:function(){1==this.timer_info.state&&this.timer_info.id&&clearTimeout(this.timer_info.id),this.timer_info.state=0},resume:function(){this.timer_info.state=1,this.timer_id=setTimeout(a.proxy(this._timer_fn,this),this.options.delay)}},a.jQueryPlugin("timer")}(jQuery),function(a){function b(b,d){return this.each(function(){var e=a(this),f=a.extend({},c.DEFAULTS,"object"==typeof b&&b),g=e.data("danmu"),h="string"==typeof b?b:0/0;g||e.data("danmu",g=new c(this,f)),h&&g[h](d)})}var c=function(b,c){this.$element=a(b),this.options=c,this.id=a(b).attr("id"),a(b).data("nowTime",0),a(b).data("danmuList",c.danmuList),a(b).data("opacity",c.opacity),a(b).data("paused",1),a(b).data("topSpace",0),a(b).data("bottomSpace",0),this.$element.css({position:"absolute",left:this.options.left,top:this.options.top,width:this.options.width,height:this.options.height,"z-index":this.options.zindex,color:c.defaultFontColor,overflow:"hidden","pointer-events":"none"});var d=this;d.height=this.$element.height(),d.width=this.$element.width(),d.speed=1e3/c.speed,this.launched=[],this.preTime=0;var e=this.options.maxCountInScreen,f=this.options.maxCountPerSec,g=0,h=0;this.rowCount=parseInt(d.height/c.FontSizeBig),d.options.SubtitleProtection&&(d.rowCount=d.rowCount-3),this.rows=[],this.topRows=[],this.bottomRows=[],this.initRows=function(a){for(var b=0;b<a.rowCount;b++)a.rows[b]=0,a.topRows[b]=0,a.bottomRows[b]=0},this.initRows(this),d.getRow=function(a){for(var b=0;0!==a.rows[b];)if(b+=1,b>=a.rowCount){a.initRows(a),b=0;break}return b},d.getTopRow=function(a){for(var b=0;b<a.topRows.length;b++)if(0==a.topRows[b])return b},d.getBottomRow=function(a){for(var b=0;b<a.bottomRows.length;b++)if(0==a.bottomRows[b])return b},d.checkRow=function(b){for(var c in b.rows){var d=a("#"+b.rows[c]),e=d.position(),f=b.$element.width()-d.width();0!==b.rows[c]&&"undefined"!=typeof e&&e.left<f&&(b.rows[c]=0)}},a("<div class='danmakuTimer'></div>").appendTo(this.$element),this.$timer=a(".danmakuTimer"),this.$timer.timer({delay:100,repeat:c.sumTime,autostart:!1,callback:function(i){setTimeout(function(){d.options.danmuLoop&&a(b).data("nowTime")>=d.options.sumTime&&a(b).data("nowTime",0),a(b).data("nowTime",a(b).data("nowTime")+1),d.height=a(b).height(),d.width=a(b).width(),Math.abs(a(b).data("nowTime")-(d.preTime+1))>10&&(d.launched=[]),d.preTime=a(b).data("nowTime");var j=d.rowCount;d.rowCount=parseInt(d.height/c.FontSizeBig);var k=d;setTimeout(function(){d.checkRow(k)},0),d.options.SubtitleProtection&&(d.rowCount=d.rowCount-3),0!==j&&d.rowCount!==j&&d.initRows(d),h=0;var l=a(b).data("nowTime"),m=a(b).data("danmuList");if(m&&m[l]&&a.inArray(l,d.launched)<0){for(var n=a(b).data("nowTime"),o=a(b).data("danmuList")[n],p=o.length-1;p>=0;p--){setTimeout(function(){d.checkRow(d)},0);var q="<span class='danmaku' id='"+d.id+"tempDanmaku'></span>";a(b).append(q);var r=o[p];if(a("#"+d.id+"tempDanmaku").text(r.text).css({color:r.color,"text-shadow":" 0px 0px 2px #000000","-moz-opacity":a(b).data("opacity"),opacity:a(b).data("opacity"),"white-space":"nowrap","font-weight":"bold","font-family":"SimHei","font-size":c.FontSizeBig}),r.color<"#777777"&&a("#"+d.id+"tempDanmaku").css({"text-shadow":" 0px 0px 2px #FFFFFF"}),r.hasOwnProperty("isnew")&&a("#"+d.id+"tempDanmaku").css({border:"2px solid "+r.color}),0==r.size&&a("#"+d.id+"tempDanmaku").css("font-size",c.fontSizeSmall),0==r.position){var s=d.id+"fly"+parseInt((new Date).getTime()).toString();if(a("#"+d.id+"tempDanmaku").attr("id",s),e>=g&&f>=h){d.checkRow(d);var t=d.getRow(d);d.rows[t]=s,r.row=t;var u=t*c.FontSizeBig;r.width=a("#"+s).width();var v=a("#"+d.id).width();a("#"+s).css({width:a("#"+s).width(),position:"absolute",top:u,left:v});var w=(a(b).width()+400)/d.speed;g++,h++,a("#"+s).animate({left:-(a("#"+s).width()+400)},w,function(){a(this).remove(),g--,h--})}else a("#"+s).remove()}else if(1==r.position){var x=d.id+"top"+parseInt(1e4*Math.random()).toString();a("#"+d.id+"tempDanmaku").attr("id",x);var y=d.getTopRow(d);a(b).data("topSpace",c.FontSizeBig*y),d.topRows[y]=1,a("#"+x).css({width:"100%","text-align":"center",position:"absolute",top:a(b).data("topSpace"),left:"0"}),a("#"+x).data("row",y),a("#"+x).fadeTo(c.topBottomDanmuTime,a(b).data("opacity"),function(){d.topRows[a(this).data("row")]=0,a(this).remove()})}else if(2==r.position){var z=d.id+"bottom"+parseInt(1e4*Math.random()).toString();a("#"+d.id+"tempDanmaku").attr("id",z);var y=d.getBottomRow(d);a(b).data("bottomSpace",c.FontSizeBig*y),d.bottomRows[y]=1,a("#"+z).css({width:c.width,left:"0","text-align":"center",position:"absolute",bottom:0+a(b).data("bottomSpace")}),a("#"+z).data("row",y),a("#"+z).fadeTo(c.topBottomDanmuTime,a(b).data("opacity"),function(){d.bottomRows[a(this).data("row")]=0,a(this).remove()})}o[p]=r}a(b).data("danmuList")[n]=o}d.launched.push(a(b).data("nowTime")),i==c.sumTime&&c.danmuLoop&&(d.$timer.timer("stop"),d.$timer.timer("start"))})}})};c.DEFAULTS={left:0,top:0,height:360,width:640,zindex:100,speed:8e3,sumTime:72e3,danmuLoop:!1,danmuList:{},defaultFontColor:"#FFFFFF",fontSizeSmall:16,FontSizeBig:24,opacity:"0.9",topBottomDanmuTime:6e3,SubtitleProtection:!1,positionOptimize:!1,maxCountInScreen:40,maxCountPerSec:10},c.prototype.danmuStart=function(){this.$timer.timer("start"),this.$element.data("paused",0)},c.prototype.danmuStop=function(){this.$timer.timer("stop"),a("#"+this.id+" .danmaku").remove(),nowTime=0,this.$element.data("paused",1),this.$element.data("nowTime",0)},c.prototype.danmuPause=function(){this.$timer.timer("pause"),a("#"+this.id+" .danmaku").pause(),this.$element.data("paused",1)},c.prototype.danmuResume=function(){this.$timer.timer("resume"),a("#"+this.id+" .danmaku").resume(),this.$element.data("paused",0)},c.prototype.danmuHideAll=function(){a("#"+this.id+" .danmaku").css({opacity:0}),this.initRows(this)},c.prototype.setTime=function(b){a("#"+this.id+" .danmaku").remove(),this.$element.data("nowTime",b)},c.prototype.setOpacity=function(b){a("#"+this.id+" .danmaku").css("opacity",b),this.$element.data("opacity",b)},c.prototype.getOptions=function(){return this.options},c.prototype.addDanmu=function(a){if(a instanceof Array)for(var b in a)this.$element.data("danmuList")[a[b].time]?this.$element.data("danmuList")[a[b].time].push(a[b]):(this.$element.data("danmuList")[a[b].time]=[],this.$element.data("danmuList")[a[b].time].push(a[b]));else this.$element.data("danmuList")[a.time]?this.$element.data("danmuList")[a.time].push(a):(this.$element.data("danmuList")[a.time]=[],this.$element.data("danmuList")[a.time].push(a))},a.fn.danmu=b,a.fn.danmu.Constructor=c}(jQuery),function(win,$){var SewiseDanmu=win.SewiseDanmu=function(a){this.player=null,this.danmuEngine=null,this.danmuDivID=null,this.danmuShowed=!0,this.config=a,this.secTimer=null};SewiseDanmu.fn=SewiseDanmu.prototype,SewiseDanmu.fn.init=function(a){this.player=a,this.createDanmu()},SewiseDanmu.fn.createDanmu=function(){var a=this.player.getPlayerContainer(),b=$(this.player.getPlayerContainer()).attr("id");this.danmuDivID=b+"-danmu-div",$(a).append('<div class="danmu-div" id="'+this.danmuDivID+'" ></div>'),this.danmuEngine=$("#"+this.danmuDivID),this.danmuEngine.danmu(this.config),this.registerEvent(),this.createTimer(),this.danmuEngine.danmu("danmuStart")},SewiseDanmu.fn.registerEvent=function(){var a=this;this.player.on("start",function(){a.danmuEngine.danmu("danmuResume")}),this.player.on("pause",function(){a.danmuEngine.danmu("danmuPause")}),this.player.on("ended",function(){a.danmuEngine.danmu("danmuHideAll")}),this.player.on("durationChange",function(){if(!a.config.sumTime&&!a.player.isLive){var b=a.danmuEngine.data("danmu").getOptions();b.sumTime=10*a.player.duration()}}),this.player.on("bufferBegin",function(){}),this.player.on("seek",function(){a.danmuEngine.danmu("danmuHideAll")})},SewiseDanmu.fn.createTimer=function(){this.player.isLive?this.danmuEngine.danmu("setTime",2):this.danmuEngine.danmu("setTime",2)},SewiseDanmu.fn.addDanmu=function(obj){var text=obj.text,color=obj.color,position=obj.position,size=obj.size,time;time=obj.time?obj.time:this.danmuEngine.data("nowTime")+3;var textObj;textObj=obj.isnew?'{ "text":"'+text+'","color":"'+color+'","size":"'+size+'","position":"'+position+'","time":'+time+',"isnew":""}':'{ "text":"'+text+'","color":"'+color+'","size":"'+size+'","position":"'+position+'","time":'+time+"}";var newObj=eval("("+textObj+")");this.danmuEngine.danmu("addDanmu",newObj)},SewiseDanmu.fn.addDanmuList=function(a){var b=a.length,c=0;if(this.player.isLive)for(c=0;b>c;c++)a[c].time=this.danmuEngine.data("nowTime")+3;else for(c=0;b>c;c++)a[c].time||(a[c].time=this.danmuEngine.data("nowTime")+3);this.danmuEngine.danmu("addDanmu",a)},SewiseDanmu.fn.openDanmu=function(a){a?(this.danmuShowed=!0,this.danmuEngine.css("visibility","visible")):(this.danmuShowed=!1,this.danmuEngine.css("visibility","hidden"))},SewiseDanmu.fn.stop=function(){this.danmuEngine.danmu("danmuStop")},SewiseDanmu.fn.dispose=function(){this.stop(),this.secTimer&&clearInterval(this.secTimer),this.danmuEngine.remove()}}(window,window.jQuery);